name: Build and Push Docker Images (Branch)

on:
  push:
    branches:
      - mp-bla-255-grpc-max-message-size
      - feat/mcp-claim-to-headers
      - release/v0.4.0-claim-to-headers

env:
  REGISTRY: ghcr.io
  IMAGE_PREFIX: ghcr.io/${{ github.repository_owner }}/ai-gateway
  # Base version for blackfuel fork builds (based on upstream v0.4.0)
  BASE_VERSION: "0.4.0"

jobs:
  docker_builds:
    name: ${{ matrix.command_name }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    strategy:
      matrix:
        include:
          - command_name: "controller"
            cmd_path_prefix: cmd
          - command_name: "extproc"
            cmd_path_prefix: cmd
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          cache: false
          go-version-file: go.mod

      - uses: actions/cache@v4
        with:
          path: |
            ~/.cache/go-build
            ~/.cache/golangci-lint
            ~/go/pkg/mod
            ~/go/bin
          key: build-container-${{ hashFiles('**/go.mod', '**/go.sum', '**/Makefile') }}

      - uses: docker/setup-buildx-action@v3

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        run: |
          # Use semver with blackfuel build number: v0.4.0+bf<run_number>
          TAG="v${{ env.BASE_VERSION }}+bf${{ github.run_number }}"
          echo "tag=${TAG}" >> $GITHUB_OUTPUT
          echo "Building tag: ${TAG}"

      - name: Build and Push Image
        run: |
          make docker-build.${{ matrix.command_name }} \
            CMD_PATH_PREFIX=${{ matrix.cmd_path_prefix }} \
            ENABLE_MULTI_PLATFORMS=true \
            TAG="${{ steps.meta.outputs.tag }}" \
            OCI_REGISTRY="${{ env.REGISTRY }}/${{ github.repository_owner }}" \
            DOCKER_BUILD_ARGS="--push"

      - name: Output image reference
        run: |
          echo "Image pushed: ${{ env.IMAGE_PREFIX }}-${{ matrix.command_name }}:${{ steps.meta.outputs.tag }}"

  helm_charts:
    name: Push Helm Charts
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          cache: false
          go-version-file: go.mod

      - uses: actions/cache@v4
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
            ~/go/bin
          key: helm-${{ hashFiles('**/go.mod', '**/go.sum', '**/Makefile') }}

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        run: |
          # Use semver with blackfuel build number: v0.4.0+bf<run_number>
          # Note: + is valid in semver but some registries need it URL-encoded
          VERSION="v${{ env.BASE_VERSION }}+bf${{ github.run_number }}"
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "Building helm chart version: ${VERSION}"

      - name: Package and Push Helm Charts
        run: |
          make helm-push \
            HELM_CHART_VERSION="${{ steps.meta.outputs.version }}" \
            TAG="${{ steps.meta.outputs.version }}" \
            OCI_REGISTRY="${{ env.REGISTRY }}/${{ github.repository_owner }}"

      - name: Output helm chart references
        run: |
          echo "Helm charts pushed:"
          echo "  - ${{ env.REGISTRY }}/${{ github.repository_owner }}/ai-gateway-crds-helm:${{ steps.meta.outputs.version }}"
          echo "  - ${{ env.REGISTRY }}/${{ github.repository_owner }}/ai-gateway-helm:${{ steps.meta.outputs.version }}"
