name: Build and Push Docker Images (Branch)

on:
  push:
    branches:
      - release/v0.5-bf
  workflow_dispatch:
    inputs:
      tag_suffix:
        description: 'Override bf tag suffix (e.g. "10" produces v0.5.0+bf10). Omit to auto-increment from latest tag.'
        required: false
        type: string

env:
  REGISTRY: ghcr.io
  IMAGE_PREFIX: ghcr.io/${{ github.repository_owner }}/ai-gateway
  BASE_VERSION: "0.5.0"

jobs:
  resolve_version:
    name: Resolve Version
    runs-on: ubuntu-latest
    outputs:
      git_tag: ${{ steps.version.outputs.git_tag }}
      oci_tag: ${{ steps.version.outputs.oci_tag }}
      suffix: ${{ steps.version.outputs.suffix }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-tags: true
          fetch-depth: 0

      - name: Resolve tag
        id: version
        run: |
          if [[ -n "${{ inputs.tag_suffix }}" ]]; then
            SUFFIX="${{ inputs.tag_suffix }}"
          else
            # Find latest v0.5.0+bf* git tag and increment
            LAST=$(git tag --list "v${{ env.BASE_VERSION }}+bf*" --sort=-v:refname | head -1)
            if [[ -z "$LAST" ]]; then
              echo "No existing v${{ env.BASE_VERSION }}+bf* tag found" >&2
              exit 1
            fi
            N=$(echo "$LAST" | sed 's/.*+bf//')
            SUFFIX=$((N + 1))
          fi
          # git tag uses + (semver build metadata)
          # OCI/Docker tag uses - (Docker does not support +)
          echo "suffix=${SUFFIX}" >> $GITHUB_OUTPUT
          echo "git_tag=v${{ env.BASE_VERSION }}+bf${SUFFIX}" >> $GITHUB_OUTPUT
          echo "oci_tag=v${{ env.BASE_VERSION }}-bf${SUFFIX}" >> $GITHUB_OUTPUT
          echo "Resolved: git=v${{ env.BASE_VERSION }}+bf${SUFFIX} oci=v${{ env.BASE_VERSION }}-bf${SUFFIX}"

  docker_builds:
    name: ${{ matrix.command_name }}
    needs: resolve_version
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    strategy:
      matrix:
        include:
          - command_name: "controller"
            cmd_path_prefix: cmd
          - command_name: "extproc"
            cmd_path_prefix: cmd
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          cache: false
          go-version-file: go.mod

      - uses: actions/cache@v4
        with:
          path: |
            ~/.cache/go-build
            ~/.cache/golangci-lint
            ~/go/pkg/mod
            ~/go/bin
          key: build-container-${{ hashFiles('**/go.mod', '**/go.sum', '**/Makefile') }}

      - uses: docker/setup-buildx-action@v3

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and Push Image
        run: |
          make docker-build.${{ matrix.command_name }} \
            CMD_PATH_PREFIX=${{ matrix.cmd_path_prefix }} \
            ENABLE_MULTI_PLATFORMS=true \
            TAG="${{ needs.resolve_version.outputs.oci_tag }}" \
            OCI_REGISTRY="${{ env.REGISTRY }}/${{ github.repository_owner }}" \
            DOCKER_BUILD_ARGS="--push"

      - name: Output image reference
        run: |
          echo "Image pushed: ${{ env.IMAGE_PREFIX }}-${{ matrix.command_name }}:${{ needs.resolve_version.outputs.oci_tag }}"

  helm_charts:
    name: Push Helm Charts
    needs: resolve_version
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          cache: false
          go-version-file: go.mod

      - uses: actions/cache@v4
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
            ~/go/bin
          key: helm-${{ hashFiles('**/go.mod', '**/go.sum', '**/Makefile') }}

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Package and Push Helm Charts
        run: |
          make helm-push \
            HELM_CHART_VERSION="${{ needs.resolve_version.outputs.oci_tag }}" \
            TAG="${{ needs.resolve_version.outputs.oci_tag }}" \
            OCI_REGISTRY="${{ env.REGISTRY }}/${{ github.repository_owner }}"

      - name: Output helm chart references
        run: |
          echo "Helm charts pushed:"
          echo "  - ${{ env.REGISTRY }}/${{ github.repository_owner }}/ai-gateway-crds-helm:${{ needs.resolve_version.outputs.oci_tag }}"
          echo "  - ${{ env.REGISTRY }}/${{ github.repository_owner }}/ai-gateway-helm:${{ needs.resolve_version.outputs.oci_tag }}"

  push_git_tag:
    name: Push Git Tag
    needs: [resolve_version, docker_builds, helm_charts]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Tag and push
        run: |
          git tag "${{ needs.resolve_version.outputs.git_tag }}"
          git push origin "${{ needs.resolve_version.outputs.git_tag }}"
          echo "Tagged: ${{ needs.resolve_version.outputs.git_tag }}"
